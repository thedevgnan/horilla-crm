{% load i18n static %}
<div id="model-fields-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <form id="field-permissions-form" method="post"
            {% if role %}
                action="{% url 'horilla_core:save_all_field_permissions_role' role.id %}"
                hx-post="{% url 'horilla_core:save_all_field_permissions_role' role.id %}"
            {% elif user %}
                action="{% url 'horilla_core:save_all_field_permissions_user' user.id %}"
                hx-post="{% url 'horilla_core:save_all_field_permissions_user' user.id %}"
            {% elif is_bulk %}
                action="{% url 'horilla_core:save_bulk_field_permissions' %}"
                hx-post="{% url 'horilla_core:save_bulk_field_permissions' %}"
            {% endif %}
            hx-swap="innerHTML">
            {% csrf_token %}
            <input type="hidden" name="app_label" value="{{ app_label }}">
            <input type="hidden" name="model_name" value="{{ model_name }}">

            {% if is_bulk %}
                <input type="hidden" name="user_ids" value="{{ selected_user_ids }}">
            {% endif %}

            <!-- Modal Header -->
            <div class="text-primary-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold">
                   {% trans "Field Level Permissions" %}
                </h3>
                <button type="button" onclick="closeModal()" class="cursor-pointer">
                    <img src="{% static 'assets/icons/close.svg' %}" alt="Close" />
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 pt-1">
                <div class="mb-4 text-sm text-gray-600">
                    <div class="flex items-center gap-10 text-sm text-gray-600">
                        {% if role %}
                            <p>
                                <strong>{% trans "Role:" %}</strong> {{ role.role_name }}
                            </p>
                        {% elif user %}
                            <p>
                                <strong>{% trans "User:" %}</strong> {{ user.get_full_name }}
                            </p>
                            {% if user.role %}
                                <p class="text-xs bg-blue-50 px-2 py-1 rounded">
                                    <strong>{% trans "Role:" %}</strong> {{ user.role.role_name }}
                                </p>
                            {% endif %}
                        {% elif is_bulk %}
                            <p>
                                <strong>{% trans "Selected Users:" %}</strong> {{ selected_users_count }}
                            </p>
                        {% endif %}
                        <p>
                            <strong>{% trans "Model:" %}</strong> {{ verbose_name }}
                        </p>
                    </div>

                    {% if is_bulk and selected_users_count == 0 %}
                        <div class="mt-3 p-3 bg-yellow-50 border border-[#f3edb0] rounded-lg">
                            <p class="text-xs text-yellow-800">
                                <strong>{% trans "Warning:" %}</strong> {% trans "No users selected. Please select atleast one user." %}
                            </p>
                        </div>
                    {% endif %}
                </div>

                {% if fields %}
                    <div class="custom-scroll overflow-y-auto max-h-[calc(70vh-100px)] border-t border-primary-300">
                        <table class="w-full border-separate border-spacing-0 overflow-hidden">
                            <thead class="bg-primary-300 text-primary-600 sticky top-0">
                                <tr>
                                    <th class="text-[.8rem] font-bold text-left p-2 rounded-tl-md">
                                        {% trans "Fields" %}
                                    </th>
                                    <th class="text-[.8rem] font-bold text-center p-2">
                                        {% trans "Read Only" %}
                                    </th>
                                    <th class="text-[.8rem] font-bold text-center p-2">
                                        {% trans "Read and Write" %}
                                    </th>
                                    <th class="text-[.8rem] font-bold text-center p-2 rounded-tr-md">
                                        {% trans "Don't Show" %}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for field in fields %}
                                    <tr class="hover:bg-primary-50">
                                        <td class="text-[.8rem] border-[.3px] border-[#e9e9e9] text-left p-2 {% if forloop.last %}rounded-bl-md{% endif %}">
                                            <div class="flex items-center gap-2">
                                                <div>
                                                    <div class="font-medium flex items-center gap-1">
                                                        {{ field.verbose_name }}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-[.8rem] border-[.3px] border-[#e9e9e9] text-center p-2">
                                            <input
                                                id="field-{{ field.name }}-readonly"
                                                type="radio"
                                                value="readonly"
                                                name="field-{{ field.name }}"
                                                class="border-[1px] border-[solid] border-[#cbcbcb] w-3 h-3 text-[#e54f38] bg-white focus:ring-[#e54f38] cursor-pointer"
                                                {% if field.current_permission == 'readonly' %}checked{% endif %}
                                            />
                                        </td>
                                        <td class="text-[.8rem] border-[.3px] border-[#e9e9e9] text-center p-2">
                                            <input
                                                id="field-{{ field.name }}-readwrite"
                                                type="radio"
                                                value="readwrite"
                                                name="field-{{ field.name }}"
                                                class="border-[1px] border-[solid] border-[#cbcbcb] w-3 h-3 text-[#e54f38] bg-white focus:ring-[#e54f38] cursor-pointer"
                                                {% if field.current_permission == 'readwrite' or not field.current_permission %}checked{% endif %}
                                            />
                                        </td>
                                        <td class="text-[.8rem] border-[.3px] border-[#e9e9e9] text-center p-2 {% if forloop.last %}rounded-br-md{% endif %}">
                                            <input
                                                id="field-{{ field.name }}-hidden"
                                                type="radio"
                                                value="hidden"
                                                name="field-{{ field.name }}"
                                                class="border-[1px] border-[solid] border-[#cbcbcb] w-3 h-3 text-[#e54f38] bg-white focus:ring-[#e54f38] cursor-pointer"
                                                {% if field.current_permission == 'hidden' %}checked{% endif %}
                                            />
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        {% trans "No fields found for this model." %}
                    </div>
                {% endif %}
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
                <button
                    type="button"
                    onclick="closeModal()"
                    class="text-primary-600 px-4 py-2 border border-primary-600 rounded hover:bg-gray-300 transition-colors text-sm"
                >
                    {% trans "Cancel" %}
                </button>
                <button
                type="submit"
                class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 transition-colors text-sm {% if is_bulk and selected_users_count == 0 %}opacity-50 cursor-not-allowed{% endif %}"
                {% if is_bulk and selected_users_count == 0 %}disabled {% endif %}
            >
                {% trans "Save All Changes" %}
            </button>
            </div>
        </form>
    </div>
</div>
