{% load i18n %}
<div class="p-5 pb-0 border-t border-primary-300">
    <div class="border border-primary-300 rounded-md bg-white">
        <div class="bg-primary-300 px-4 py-3">
            <div class="flex gap-4 items-center justify-between">
                <div class="flex items-center">
                    <input
                        type="text"
                        class="text-color-600 px-2 py-1.5 pr-[40px] pw-full border border-dark-50 rounded-md focus-visible:outline-0 placeholder:text-[#d3d3d3] placeholder:text-xs text-sm [transition:.3s] focus:border-primary-600"
                        placeholder="{% trans 'Search models...' %}"
                        hx-get="{% url 'horilla_core:search_user_models' user.id %}"
                        hx-trigger="input changed delay:500ms"
                        hx-target="#user-model-container-{{ user.id }}"
                        hx-swap="innerHTML"
                        name="search"
                        data-user-id="{{ user.id }}"
                    />
                </div>

                <label class="flex items-center font-semibold text-primary-600">
                    <input
                        type="checkbox"
                        id="master-select-all-user"
                        class="model-select-all w-4 h-4 border border-[#cfcfcf] rounded-sm accent-[#e54f38] mr-2"
                        {% if master_select_all_checked %}checked{% endif %}
                        hx-post="{% url 'horilla_core:update_user_all_permissions' user.id %}"
                        hx-trigger="change"
                        hx-vals='js:{"checked": event.target.checked}'
                        hx-on::after-request="$('#reloadMessagesButton').click();toggleAllUserChecked(this)"
                        hx-swap="none"/>
                    {% trans "Select All" %}
                </label>
            </div>
        </div>
        <div id="user-model-container-{{ user.id }}">
            {% for model in all_models %}
                <div class="border-[1px] border-[solid] border-[#efefef] last:border-b-0 px-4 py-2">
                    <div class="flex gap-4 permItem">
                        <div class="flex items-center">
                            <label class="flex items-center">
                                <input
                                    type="checkbox"
                                    class="model-select-all w-4 h-4 bg-[#E9EDF7] rounded-sm accent-[#e54f38] mr-2"
                                    {% if model.select_all_checked %}checked{% endif %}
                                    hx-post="{% url 'horilla_core:update_user_model_permissions' user.id %}"
                                    hx-trigger="change"
                                    hx-vals='js:{"model_name": "{{ model.model_name }}", "app_label": "{{ model.app_label }}", "checked": event.target.checked}'
                                    hx-on::after-request="$('#reloadMessagesButton').click();toggleUserChecked($(this));"
                                    hx-swap="none"
                                />
                            </label>
                        </div>
                        <div class="w-64">
                            {% if model.is_managed %}
                                <button
                                    class="whitespace-nowrap text-left hover:text-primary-600"
                                    hx-get="{% url 'horilla_core:model_fields_modal_user' user.id model.app_label model.model_name %}?context=user"
                                    hx-target="#modalBox"
                                    hx-swap="innerHTML"
                                    onclick="openModal()"
                                >
                                    {{ model.verbose_name }}
                                </button>
                            {% else %}
                                <div class="relative group inline-block">
                                    <span class="whitespace-nowrap text-black cursor-pointer">
                                        {{ model.verbose_name }}
                                    </span>
                                    <span class="min-w-max z-40 absolute h-auto py-[3px] px-[15px] left-[40px] top-0 bg-[#000000] text-[.7rem] rounded-[5px] text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                                        {% trans 'Field permissions not available for this model' %}
                                    </span>
                                </div>
                            {% endif %}
                        </div>

                        <div class="flex gap-12 text-xs text-dark-300">
                            {% for perm in model.permissions %}
                                <label class="flex items-center whitespace-nowrap">
                                    <input type="checkbox"
                                        name="permissions"
                                        id="perm_{{ user.id }}_{{ perm.id }}"
                                        value="{{ perm.id }}"
                                        class="individual-perm w-4 h-4 border border-[#cfcfcf] rounded-sm accent-[#e54f38] mr-2"
                                        {% if perm.has_perm %}checked{% endif %}
                                        hx-post="{% url 'horilla_core:update_user_permissions' user.id %}"
                                        hx-trigger="change"
                                        hx-vals='js:{"permission_id": "{{ perm.id }}", "checked": event.target.checked}'
                                        hx-target="#messages-container"
                                        hx-swap="innerHTML"
                                    />
                                    {{ perm.label }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function toggleUserChecked($elm) {
        var is_checked = $elm.is(':checked');
        $elm.closest('.permItem').find('.individual-perm').prop('checked', is_checked);
    }

    function toggleAllUserChecked(el) {
        var $elm = $(el);
        var is_checked = $elm.is(':checked');

        $('.model-select-all, .individual-perm').prop('checked', is_checked);
    }
</script>
